<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evorra - Connect & Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #0f0f17; color: #e0e0e0; margin: 0; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f0f17; display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .loader-svg { animation: spin 1.5s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #app { display: flex; height: 100vh; }
        #sidebar { width: 240px; background: #181820; padding: 20px; box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5); }
        #chat { flex: 1; display: flex; flex-direction: column; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; }
        #message-input { padding: 10px; background: #181820; }
        .server, .channel { padding: 10px; margin: 5px 0; border-radius: 8px; transition: all 0.3s ease; cursor: pointer; }
        .server:hover, .channel:hover { background: #2a2a3b; transform: translateX(3px); }
        .message { margin: 10px 0; padding: 12px; background: #2a2a3b; border-radius: 8px; animation: fadeIn 0.5s ease-out; }
        .parallax { background: url('https://source.unsplash.com/random/1920x1080?galaxy') center/cover; height: 120px; background-attachment: fixed; border-radius: 8px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .btn { transition: all 0.3s ease; border-radius: 8px; }
        .btn:hover { transform: scale(1.05); background: #7c3aed; }
        .error { color: #ff6b6b; text-align: center; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #181820; }
        ::-webkit-scrollbar-thumb { background: #4b4b6b; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="loader">
        <svg class="loader-svg" width="60" height="60" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M50 10L50 30M50 70L50 90M10 50L30 50M70 50L90 50" stroke="#c084fc" stroke-width="10" stroke-linecap="round"/>
            <circle cx="50" cy="50" r="40" stroke="#f0abfc" stroke-width="10" stroke-dasharray="20 20"/>
        </svg>
    </div>
    <div id="app" class="hidden">
        <div id="sidebar" class="flex flex-col">
            <div class="flex items-center mb-6">
                <img src="path/to/evara-logo.svg" alt="Evorra Logo" class="h-8 w-8 mr-2">
                <h1 class="text-xl font-bold text-indigo-400">Evorra</h1>
            </div>
            <div class="parallax mb-6"></div>
            <h2 class="text-lg font-semibold flex items-center mb-2"><i class='bx bx-server mr-2 text-indigo-400'></i>Servers</h2>
            <div id="servers" class="mb-4"></div>
            <h2 class="text-lg font-semibold flex items-center mb-2"><i class='bx bx-chat mr-2 text-indigo-400'></i>Channels</h2>
            <div id="channels"></div>
            <button id="login-btn" class="btn bg-indigo-600 text-white p-2 mt-4 flex items-center"><i class='bx bx-log-in mr-2'></i>Login</button>
            <button id="logout-btn" class="btn bg-red-600 text-white p-2 mt-2 flex items-center hidden"><i class='bx bx-log-out mr-2'></i>Logout</button>
        </div>
        <div id="chat">
            <div id="messages" class="flex-1"></div>
            <div id="message-input" class="flex">
                <input id="message-text" type="text" placeholder="Type a message..." class="flex-1 p-2 text-gray-900 bg-gray-200 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-indigo-400">
                <button id="send-btn" class="btn bg-indigo-600 text-white p-2 rounded-r-lg flex items-center"><i class='bx bx-send mr-2'></i>Send</button>
            </div>
        </div>
    </div>

    <script>
        // Ensure Supabase is loaded
        if (typeof supabase === 'undefined') {
            console.error('Supabase library not loaded. Check the script tag or network connection.');
            document.getElementById('messages').innerHTML = '<div class="error">Error: Supabase not loaded. Check console for details.</div>';
        } else {
            // Initialize Supabase
            const supabase = window.supabase.createClient('Yhttps://lxtaitbzpvdzyonxhfmm.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx4dGFpdGJ6cHZkenlvbnhoZm1tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNTA3ODIsImV4cCI6MjA3NDkyNjc4Mn0.gNIq2oJFbKgz7TayICLi6djNB_j2PxAlAZYyE0s5amM', {
                auth: { persistSession: true }
            });

            // DOM Elements
            const loader = document.getElementById('loader');
            const app = document.getElementById('app');
            const serversDiv = document.getElementById('servers');
            const channelsDiv = document.getElementById('channels');
            const messagesDiv = document.getElementById('messages');
            const messageInput = document.getElementById('message-text');
            const sendBtn = document.getElementById('send-btn');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');

            let currentChannel = null;
            let user = null;

            // Show app after 2s
            setTimeout(() => {
                loader.classList.add('hidden');
                app.classList.remove('hidden');
            }, 2000);

            // Authentication
            loginBtn.addEventListener('click', async () => {
                try {
                    const email = prompt('Email:');
                    const password = prompt('Password:');
                    if (!email || !password) {
                        showError('Please provide email and password');
                        return;
                    }
                    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                    if (error) throw new Error(error.message);
                    user = data.user;
                    loginBtn.classList.add('hidden');
                    logoutBtn.classList.remove('hidden');
                    loadServers();
                } catch (error) {
                    showError('Login failed: ' + error.message);
                }
            });

            logoutBtn.addEventListener('click', async () => {
                try {
                    await supabase.auth.signOut();
                    user = null;
                    loginBtn.classList.remove('hidden');
                    logoutBtn.classList.add('hidden');
                    serversDiv.innerHTML = '';
                    channelsDiv.innerHTML = '';
                    messagesDiv.innerHTML = '';
                } catch (error) {
                    showError('Logout failed: ' + error.message);
                }
            });

            // Load servers (mock for demo)
            async function loadServers() {
                try {
                    serversDiv.innerHTML = '';
                    const servers = [{ id: 1, name: 'Evorra Hub' }]; // Replace with: await supabase.from('servers').select('*');
                    servers.forEach(server => {
                        const div = document.createElement('div');
                        div.className = 'server flex items-center';
                        div.innerHTML = `<i class='bx bx-server mr-2 text-indigo-400'></i>${server.name}`;
                        div.onclick = () => loadChannels(server.id);
                        serversDiv.appendChild(div);
                    });
                } catch (error) {
                    showError('Failed to load servers: ' + error.message);
                }
            }

            // Load channels
            async function loadChannels(serverId) {
                try {
                    channelsDiv.innerHTML = '';
                    const channels = [{ id: 1, name: 'general', type: 'text' }]; // Replace with: await supabase.from('channels').select('*').eq('server_id', serverId);
                    channels.forEach(channel => {
                        const div = document.createElement('div');
                        div.className = 'channel flex items-center';
                        div.innerHTML = `<i class='bx bx-chat mr-2 text-indigo-400'></i>${channel.name}`;
                        div.onclick = () => {
                            currentChannel = channel;
                            loadMessages(channel.id);
                        };
                        channelsDiv.appendChild(div);
                    });
                } catch (error) {
                    showError('Failed to load channels: ' + error.message);
                }
            }

            // Load messages
            async function loadMessages(channelId) {
                try {
                    messagesDiv.innerHTML = '';
                    const { data: messages, error } = await supabase
                        .from('messages')
                        .select('*')
                        .eq('channel_id', channelId)
                        .order('created_at', { ascending: true });
                    if (error) throw new Error(error.message);
                    messages.forEach(msg => {
                        const div = document.createElement('div');
                        div.className = 'message';
                        div.innerHTML = `<span class="font-semibold text-indigo-400">${msg.user_id.slice(0, 8)}:</span> ${msg.content}`;
                        messagesDiv.appendChild(div);
                    });
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;

                    // Unsubscribe from previous channels
                    supabase.removeAllChannels();
                    // Subscribe to real-time messages
                    supabase
                        .channel(`channel-${channelId}`)
                        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `channel_id=eq.${channelId}` }, payload => {
                            const div = document.createElement('div');
                            div.className = 'message';
                            div.innerHTML = `<span class="font-semibold text-indigo-400">${payload.new.user_id.slice(0, 8)}:</span> ${payload.new.content}`;
                            messagesDiv.appendChild(div);
                            messagesDiv.scrollTop = messagesDiv.scrollHeight;
                        })
                        .subscribe();
                } catch (error) {
                    showError('Failed to load messages: ' + error.message);
                }
            }

            // Send message
            sendBtn.addEventListener('click', async () => {
                try {
                    if (!currentChannel || !user || !messageInput.value) {
                        showError('Please select a channel and type a message');
                        return;
                    }
                    const { error } = await supabase
                        .from('messages')
                        .insert({ channel_id: currentChannel.id, user_id: user.id, content: messageInput.value });
                    if (error) throw new Error(error.message);
                    messageInput.value = '';
                } catch (error) {
                    showError('Failed to send message: ' + error.message);
                }
            });

            // Error display
            function showError(message) {
                const div = document.createElement('div');
                div.className = 'error';
                div.textContent = message;
                messagesDiv.appendChild(div);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                setTimeout(() => div.remove(), 3000);
            }

            // Initialize
            supabase.auth.getSession().then(({ data: { session } }) => {
                if (session) {
                    user = session.user;
                    loginBtn.classList.add('hidden');
                    logoutBtn.classList.remove('hidden');
                    loadServers();
                }
            });
        }
    </script>
</body>
</html>
